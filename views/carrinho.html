<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu principal</title>
    <link rel="stylesheet" href="../Css/style.css">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
        integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
        crossorigin="anonymous"></script>
    <script src="/JS/carrinho.js"></script>
</head>

<body>
    <div id="container">
        <nav class="navbar navbar-expand-lg justify-content-between">
            <a class="navbar-brand" href="index.html"> <img id="logo" src="../img/logo nome.png"></a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <form class="form-inline">
                <a href="./pedidos.html"><button type="button" id="btn" class="btn">Pedir Delivery</button></a>

            </form>

        </nav>


        <h2 class="section-title">Carrinho</h2>
        <div class="mx-auto w-50">
            <table class="cart-table mx-auto">
                <thead>
                    <tr>
                        <th class="table-head-item first-col">Item</th>
                        <th class="table-head-item second-col">Preço</th>
                        <!-- <th class="table-head-item third-col">Quantidade</th> -->
                    </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" class="cart-total-container">
                            <strong>Total</strong>
                            <span class="preco-pizza">R$0,00</span>
                        </td>
                    </tr>
                </tfoot>
            </table>



        </div>
        <button type="button" class="purchase-button">Finalizar Compra</button>


        <footer class="footer">
            <div class="row">
                <div class="col-md-6 footer-column border-right">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <span class="footer-heading"><img src="../img/logo lateral.png" id="logoroda">
                                <br>
                                Da Hora Pizzaria</span>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link " href="#"> (47) 9 9925-3412</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link bi bi-facebook"
                                href="https://www.facebook.com/p/Da-hora-pizzaria-100044583169387/"> Da Hora
                                pizzaria</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">Dahorapizza@gmail.com</a>
                        </li>
                    </ul>
                </div>

                <div class="col-md-6 footer-column">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <span class="footer-heading"><img src="../img/logo flux.png" id="logoroda">
                                <br>
                                Flux System</span>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">h.xavier1232012@gmail.com</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">alyson.vinicius@icloud.com</a>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="row text-center">
                <div class="col-md-2 box">
                    <span class="copyright quick-links">Copyright &copy; Flux System
                        <script>document.write(new Date().getFullYear())</script>
                    </span>
                </div>
            </div>
        </footer>

        <style>
            .pizza-item {
                position: relative;
            }

            .pizza-item .combo-nome {
                font-size: 25px;
                font-weight: 700;
                line-height: 1em;
            }

            .pizza-item .pizza-nome {
                font-size: 20px;
                color: #666;
                padding-left: 10px;
                line-height: 1em;
                margin-left: 50px;
            }

            .pizza-item .sabor-nome {
                font-size: 18px;
                line-height: 1em;
                font-style: italic;
                color: #aaaaaa;
                padding-left: 15px;
                position: relative;
                margin-left: 50px;
            }

            .pizza-item .sabor-nome:before {
                content: '-';
            }

            .preco-pizza {
                text-align: center;
                font-size: 25px;

            }

            .btn-excluir {
                margin-left: 50px;

            }

            footer {
                padding: 75px;
                position: relative;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 395px;
            }
        </style>

        <script>
            $(document).ready(function () {
                // Função para calcular a soma inicial e atualizar o localStorage
                function calcularESalvarSomaInicial() {
                    var somaInicial = 0;

                    // Iterar sobre cada linha da tabela
                    $('.preco-pizza').each(function () {
                        var precoString = $(this).text().replace('R$', '').replace(',', '.').trim();
                        var preco = parseFloat(precoString);
                        somaInicial += preco;
                    });

                    // Exibir a soma na tabela
                    $('.cart-total-container .preco-pizza').text('R$' + somaInicial.toFixed(2));

                    // Salvar a soma inicial no localStorage
                    localStorage.setItem('totalCarrinho', somaInicial.toFixed(2));
                }

                // Função para remover um item da tabela e do localStorage
                function removerItem(index) {
                    var pizzasCarrinhoArr = JSON.parse(localStorage.getItem('pizzasCarrinho')) || [];

                    // Obter o preço do item a ser removido
                    var precoRemovido = parseFloat($('.cart-table tbody tr').eq(index).find('.preco-pizza').text().replace('R$', '').replace(',', '.').trim());

                    // Remover a linha da tabela
                    $('.cart-table tbody tr').eq(index).remove();

                    // Remover o item do array no localStorage
                    pizzasCarrinhoArr.splice(index, 1);

                    // Salvar o array atualizado de volta no localStorage
                    localStorage.setItem('pizzasCarrinho', JSON.stringify(pizzasCarrinhoArr));

                    // Recalcular a soma inicial e atualizar a exibição
                    calcularESalvarSomaInicial();

                    // Recarregar a página para refletir as mudanças
                    location.reload();
                }

                // Função para finalizar a compra
                function finalizarCompra() {
                    // Limpar o localStorage ao finalizar a compra
                    localStorage.removeItem('pizzasCarrinho');

                    // Exibir uma mensagem ou redirecionar o usuário, conforme necessário
                    alert('Pedido Finalizado! Total: R$' + localStorage.getItem('totalCarrinho'));

                    // Recarregar a página
                    location.reload();
                }

                // Chamar a função ao carregar a página
                calcularESalvarSomaInicial();

                // Adicionar manipulador de evento para recalcular a soma quando o conteúdo da tabela mudar
                $('.cart-table').on('DOMSubtreeModified', function () {
                    calcularESalvarSomaInicial();
                });

                // Adicionar manipulador de evento para recalcular a soma quando o botão de compra for clicado
                $('.purchase-button').on('click', function () {
                    finalizarCompra();
                });

                // Adicionar manipulador de evento para o botão de exclusão
                $('.cart-table').on('click', '.btn-excluir', function () {
                    var index = $(this).closest('tr').index();
                    removerItem(index);
                });
            });

            var pizzasCarrinhoArr = localStorage.pizzasCarrinho;
            if (!pizzasCarrinhoArr) {
                pizzasCarrinhoArr = [];
            } else {
                pizzasCarrinhoArr = JSON.parse(pizzasCarrinhoArr);
            }

            //parseFloat($mdlContent.find('.price').text().replaceAll('.', '').replaceAll(',', '.').replace('R$', ''))

            if (pizzasCarrinhoArr.length > 0) {

                //console.dir(pizzasCarrinhoArr)

                pizzasCarrinhoArr.forEach(function (_pizza, index) {
                    //console.dir(_pizza);

                    var pizzaNomeHTML = '',
                        pizzaSaboresHTML = '';

                    Object.keys(_pizza.pizzas).forEach(function (_pizzaNome) {
                        var _pizzaSabores = _pizza.pizzas[_pizzaNome];
                        // console.dir(_pizzaNome)
                        // console.dir(_pizzaSabores)
                        // console.dir('--')
                        pizzaNomeHTML = '<div class="pizza-nome">' + _pizzaNome + '</div>';

                        _pizzaSabores.forEach(function (_pizzaSabor) {
                            pizzaSaboresHTML += '<div class="sabor-nome">' + _pizzaSabor + '</div>';
                        });
                    })

                    console.dir(pizzaNomeHTML)
                    console.dir(pizzaSaboresHTML)

                    var _tr = `
                    <tr>
                        <td>
                            <div class="pizza-item">
                                <div class="combo-nome ">` + _pizza.combo + `</div>
                                `+ pizzaNomeHTML + `
                                `+ pizzaSaboresHTML + `
                            </div>
                            <br>
                        </td>
                        <td class="preco-pizza">` + _pizza.preco + `
                            <button type="button" class="btn btn-danger btn-excluir">Excluir</button></td>
                    </tr>`;

                    console.dir(_tr)

                    $('.cart-table tbody').append(_tr);
                })

            } else {
                console.dir('alskd')
                $('.purchase-button').after('<br><br><h2 class="text-center">Nenhum produto selecionado</h2>');
                $('.purchase-button').remove();
            }







        </script>

</body>

</html>